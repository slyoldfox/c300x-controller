// =======================================================================================================================
// DO NOT EDIT, this is a generated file, generate it with $ npm run build:sipbundle:dev or npm run build:sipbundle:prod
// =======================================================================================================================
(()=>{var e={494:(e,t,r)=>{r(23);var n=r(278),s=r(250),o=r(613),a=r(194),i=r(756),c=r(857),u=r(982);function p(e,t){e.lastIndex=t.i;var r=e.exec(t.s);if(r&&r.index===t.i)return t.i=e.lastIndex,r}function d(e,t){t.params=t.params||{};for(var r=/\s*;\s*([\w\-.!%*_+`'~]+)(?:\s*=\s*([\w\-.!%*_+`'~]+|"[^"\\]*(\\.[^"\\]*)*"))?/g,n=p(r,e);n;n=p(r,e))t.params[n[1].toLowerCase()]=n[2]||null;return t}function l(e,t,r){r=r||[];var n=/\s*,\s*/g;do{r.push(e(t))}while(t.i<t.s.length&&p(n,t));return r}function h(e,t){return t?t+","+e.s:e.s}function f(e){var t=p(/((?:[\w\-.!%*_+`'~]+)(?:\s+[\w\-.!%*_+`'~]+)*|"[^"\\]*(?:\\.[^"\\]*)*")?\s*\<\s*([^>]*)\s*\>|((?:[^\s@"<]@)?[^\s;]+)/g,e);return d(e,{name:t[1],uri:t[2]||t[3]||""})}function m(e){var t=f(e);return t.uri=P(t.uri),t}function g(e){var t=/(\d+)\s*([\S]+)/.exec(e.s);return{seq:+t[1],method:unescape(t[2])}}function v(e){var t={scheme:p(/([^\s]*)\s+/g,e)[1]},r=p(/([^\s,"=]*)\s*=\s*([^\s,"]+|"[^"\\]*(?:\\.[^"\\]*)*")\s*/g,e);for(t[r[1]]=r[2];r=p(/,\s*([^\s,"=]*)\s*=\s*([^\s,"]+|"[^"\\]*(?:\\.[^"\\]*)*")\s*/g,e);)t[r[1]]=r[2];return t}t.parseAOR=f;var y={i:"call-id",m:"contact",e:"contact-encoding",l:"content-length",c:"content-type",f:"from",s:"subject",k:"supported",t:"to",v:"via"},b={to:f,from:f,contact:function(e,t){return"*"==e?e:l(f,e,t)},route:l.bind(0,m),"record-route":l.bind(0,m),path:l.bind(0,m),cseq:g,"content-length":function(e){return+e.s},via:l.bind(0,(function(e){var t=p(/SIP\s*\/\s*(\d+\.\d+)\s*\/\s*([\S]+)\s+([^\s;:]+)(?:\s*:\s*(\d+))?/g,e);return d(e,{version:t[1],protocol:t[2],host:t[3],port:t[4]&&+t[4]})})),"www-authenticate":l.bind(0,v),"proxy-authenticate":l.bind(0,v),authorization:l.bind(0,v),"proxy-authorization":l.bind(0,v),"authentication-info":function(e){var t={},r=p(/([^\s,"=]*)\s*=\s*([^\s,"]+|"[^"\\]*(?:\\.[^"\\]*)*")\s*/g,e);for(t[r[1]]=r[2];r=p(/,\s*([^\s,"=]*)\s*=\s*([^\s,"]+|"[^"\\]*(?:\\.[^"\\]*)*")\s*/g,e);)t[r[1]]=r[2];return t},"refer-to":f};function S(e){if(""!==(e=e.split(/\r\n(?![ \t])/))[0]){var t={};if(function(e,t){var r=e.match(/^SIP\/(\d+\.\d+)\s+(\d+)\s*(.*)\s*$/);if(r)return t.version=r[1],t.status=+r[2],t.reason=r[3],t}(e[0],t)||function(e,t){var r=e.match(/^([\w\-.!%*_+`'~]+)\s([^\s]+)\sSIP\s*\/\s*(\d+\.\d+)/);if(r)return t.method=unescape(r[1]),t.uri=r[2],t.version=r[3],t}(e[0],t)){t.headers={};for(var r=1;r<e.length;++r){var n=e[r].match(/^([\S]*?)\s*:\s*([\s\S]*)$/);if(!n)return;var s=unescape(n[1]).toLowerCase();s=y[s]||s;try{t.headers[s]=(b[s]||h)({s:n[2],i:0},t.headers[s])}catch(e){}}return t}}}function P(e){if("object"==typeof e)return e;var t=/^(sips?):(?:([^\s>:@]+)(?::([^\s@>]+))?@)?([\w\-\.]+)(?::(\d+))?((?:;[^\s=\?>;]+(?:=[^\s?\;]+)?)*)(?:\?(([^\s&=>]+=[^\s&=>]+)(&[^\s&=>]+=[^\s&=>]+)*))?$/.exec(e);return t?{schema:t[1],user:t[2],password:t[3],host:t[4],port:+t[5],params:(t[6].match(/([^;=]+)(=([^;=]+))?/g)||[]).map((function(e){return e.split("=")})).reduce((function(e,t){return e[t[0]]=t[1]||null,e}),{}),headers:((t[7]||"").match(/[^&=]+=[^&=]+/g)||[]).map((function(e){return e.split("=")})).reduce((function(e,t){return e[t[0]]=t[1],e}),{})}:void 0}function I(e){return e||"2.0"}function T(e){var t="";for(var r in e)t+=";"+r+(e[r]?"="+e[r]:"");return t}function E(e){if("string"==typeof e)return e;var t=(e.schema||"sip")+":";if(e.user&&(e.password?t+=e.user+":"+e.password+"@":t+=e.user+"@"),t+=e.host,e.port&&(t+=":"+e.port),e.params&&(t+=T(e.params)),e.headers){var r=Object.keys(e.headers).map((function(t){return t+"="+e.headers[t]})).join("&");r.length&&(t+="?"+r)}return t}function x(e){return(e.name||"")+" <"+E(e.uri)+">"+T(e.params)}function w(e){var t=[];for(var r in e)"scheme"!==r&&void 0!==e[r]&&t.push(r+"="+e[r]);return e.scheme?e.scheme+" "+t.join(","):t.join(",")}t.parseUri=P,t.stringifyUri=E,t.stringifyAuthHeader=w;var O={via:function(e){return e.map((function(e){return e.host?"Via: SIP/"+I(e.version)+"/"+e.protocol.toUpperCase()+" "+e.host+(e.port?":"+e.port:"")+T(e.params)+"\r\n":""})).join("")},to:function(e){return"To: "+x(e)+"\r\n"},from:function(e){return"From: "+x(e)+"\r\n"},contact:function(e){return"Contact: "+("*"!==e&&e.length?e.map(x).join(", "):"*")+"\r\n"},route:function(e){return e.length?"Route: "+e.map(x).join(", ")+"\r\n":""},"record-route":function(e){return e.length?"Record-Route: "+e.map(x).join(", ")+"\r\n":""},path:function(e){return e.length?"Path: "+e.map(x).join(", ")+"\r\n":""},cseq:function(e){return"CSeq: "+e.seq+" "+e.method+"\r\n"},"www-authenticate":function(e){return e.map((function(e){return"WWW-Authenticate: "+w(e)+"\r\n"})).join("")},"proxy-authenticate":function(e){return e.map((function(e){return"Proxy-Authenticate: "+w(e)+"\r\n"})).join("")},authorization:function(e){return e.map((function(e){return"Authorization: "+w(e)+"\r\n"})).join("")},"proxy-authorization":function(e){return e.map((function(e){return"Proxy-Authorization: "+w(e)+"\r\n"})).join("")},"authentication-info":function(e){return"Authentication-Info: "+w(e)+"\r\n"},"refer-to":function(e){return"Refer-To: "+x(e)+"\r\n"}};function C(e){return"call-id"==e?"Call-ID":e.replace(/\b([a-z])/g,(function(e){return e.toUpperCase()}))}function k(e){var t;for(var r in t=e.status?"SIP/"+I(e.version)+" "+e.status+" "+e.reason+"\r\n":e.method+" "+E(e.uri)+" SIP/"+I(e.version)+"\r\n",e.headers["content-length"]=(e.content||"").length,e.headers)void 0!==e.headers[r]&&("string"!=typeof e.headers[r]&&O[r]?t+=O[r](e.headers[r],r):t+=C(r)+": "+e.headers[r]+"\r\n");return t+="\r\n",e.content&&(t+=e.content),t}function A(e,t,r,n){var s={status:t,reason:r||"",version:e.version,headers:{via:e.headers.via,to:e.headers.to,from:e.headers.from,"call-id":e.headers["call-id"],cseq:e.headers.cseq}};return n&&(n.headers&&Object.keys(n.headers).forEach((function(e){s.headers[e]=n.headers[e]})),s.content=n.content),s}function R(e,t){if(null!==e&&"object"==typeof e){var r=Array.isArray(e)?[]:{};return Object.keys(e).forEach((function(n){r[n]=t?R(e[n],t):e[n]})),r}return e}function j(e){return"TLS"===e.toUpperCase()?5061:5060}function F(e,t,r,n){var s;t=t||function(){},r=r||60480,n=n||604800;var o="";function a(e){if((o+=e).length>r)return o="",void t();var u=o.match(/^\s*([\S\s]*?)\r\n\r\n([\S\s]*)$/);u&&(o=u[2],(s=S(u[1]))&&void 0!==s.headers["content-length"]?(s.headers["content-length"]>n&&(o="",t()),c=i,i("")):a(""))}function i(t){if((o+=t).length>=s.headers["content-length"]){s.content=o.substring(0,s.headers["content-length"]),e(s);var r=o.substring(s.headers["content-length"]);c=a,o="",a(r)}}var c=a;return function(e){c(e)}}function L(e){var t=e.toString("binary").match(/^\s*([\S\s]*?)\r\n\r\n([\S\s]*)$/);if(t){var r=S(t[1]);if(r){if(r.headers["content-length"]){var n=Math.max(0,Math.min(r.headers["content-length"],t[2].length));r.content=t[2].substring(0,n)}else r.content=t[2];return r}}}function M(e){return(e.method||e.status>=100&&e.status<=999)&&e.headers&&Array.isArray(e.headers.via)&&e.headers.via.length>0&&e.headers["call-id"]&&e.headers.to&&e.headers.from&&e.headers.cseq}function N(e,t,r,n,s,o){var a=Object.create(null),i=Object.create(null);function c(n,s){var c=[s.address,s.port].join(),u=void 0,p=0;function d(){u=[c,n.localAddress,n.localPort].join(),i[u]=a[c]}return n.setEncoding("binary"),n.on("data",F((function(e){M(e)&&(e.method&&(e.headers.via[0].params.received=s.address),o(e,{protocol:s.protocol,address:n.remoteAddress,port:n.remotePort,local:{address:n.localAddress,port:n.localPort}},n))}),(function(){console.log("Flood attempt, destroying stream"),n.destroy()}),t,r)),n.on("close",(function(){u&&delete i[u],delete a[c]})),n.on("connect",d),n.on("error",(function(){})),n.on("end",(function(){0!==p&&n.emit("error",new Error("remote peer disconnected")),n.end()})),n.on("timeout",(function(){0===p&&n.destroy()})),n.setKeepAlive(!0,6e4),n.setMaxListeners(1e4),a[c]=function(t){return++p,t&&n.on("error",t),{release:function(){t&&n.removeListener("error",t),0==--p&&n.emit("no_reference")},send:function(e){n.write(k(e),"binary")},protocol:e}},n.localPort&&d(),a[c]}var u=s((function(t){c(t,{protocol:e,address:t.remoteAddress,port:t.remotePort})}));return{open:function(e,t){var r=[e.address,e.port].join();return r in a?a[r](t):c(n(e.port,e.address),e)(t)},get:function(e,t){var r=e.local?i[[e.address,e.port,e.local.address,e.local.port].join()]:a[[e.address,e.port].join()];return r&&r(t)},destroy:function(){u&&u.close()}}}function q(e,t){var r={},s=t;function o(t,r){return Object.create(t,{send:{value:function(n){n.method&&(n.headers.via[0].host=e.publicAddress||e.address||e.hostname||c.hostname(),n.headers.via[0].port=e.port||j(this.protocol),n.headers.via[0].protocol=this.protocol,"UDP"!==this.protocol||e.hasOwnProperty("rport")&&!e.rport||(n.headers.via[0].params.rport=null)),e.logger&&e.logger.send&&e.logger.send(n,r),t.send(n)}}})}return e.logger&&e.logger.recv&&(s=function(r,n,s){e.logger.recv(r,n),t(r,n,s)}),(void 0===e.udp||e.udp)&&(r.UDP=function(e,t){var r=e.address||"0.0.0.0",s=e.port||5060,o=a.createSocket(n.isIPv6(r)?"udp6":"udp4",(function(e,n){var o=L(e);o&&M(o)&&(o.method&&(o.headers.via[0].params.received=n.address,o.headers.via[0].params.hasOwnProperty("rport")&&(o.headers.via[0].params.rport=n.port)),t(o,{protocol:"UDP",address:n.address,port:n.port,local:{address:r,port:s}}))}));function i(e,t){return{send:function(t){var r=k(t);o.send(new Buffer.from(r,"binary"),0,r.length,e.port,e.address)},protocol:"UDP",release:function(){}}}return o.bind(s,r),{open:i,get:i,destroy:function(){o.close()}}}(e,s)),(void 0===e.tcp||e.tcp)&&(r.TCP=function(e,t){return N("TCP",e.maxBytesHeaders,e.maxContentLength,(function(e,t,r){return n.connect(e,t,r)}),(function(e){}),t)}(e,s)),e.tls&&(r.TLS=function(e,t){return N("TLS",e.maxBytesHeaders,e.maxContentLength,(function(t,r,n){return i.connect(t,r,e.tls,n)}),(function(t){var r=i.createServer(e.tls,t);return r.listen(e.tls_port||5061,e.address),r}),t)}(e,s)),{open:function(e,t){return o(r[e.protocol.toUpperCase()].open(e,t),e)},get:function(e,t){var n=r[e.protocol.toUpperCase()].get(e,t);return n&&o(n,e)},send:function(e,t){var r=this.open(e);try{r.send(t)}finally{r.release()}},destroy:function(){var e=r;r=[],Object.keys(e).forEach((function(t){e[t].destroy()}))}}}function U(e){var t=Object.create(null);return function(r,n){t[r]?t[r].push(n):(t[r]=[n],e(r,(function(){var e=t[r];delete t[r];var n=arguments;e.forEach((function(e){e.apply(null,n)}))})))}}t.stringify=k,t.makeResponse=A,t.copyMessage=function(e,t){if(t)return R(e,!0);var r={uri:t?R(e.uri,t):e.uri,method:e.method,status:e.status,reason:e.reason,headers:R(e.headers,t),content:e.content};return r.headers.via=R(e.headers.via),r},t.makeStreamParser=F,t.parse=L,t.makeTransport=q;var D=U(s.resolveSrv),B=U(s.resolve4),_=U(s.resolve6);function K(e,t){if("ws"===e.params.transport)return t([{protocol:"sips"===e.schema?"WSS":"WS",host:e.host,port:e.port||("sips"===e.schema?433:80)}]);if(n.isIP(e.host)){var r=e.params.transport||"UDP";return t([{protocol:r,address:e.host,port:e.port||j(r)}])}function s(e,t){B(e,(function(r,n){_(e,(function(e,s){(n||s)&&(n||s).length?t(null,(n||[]).concat(s||[])):t(r||e,[])}))}))}if(e.port){var o=e.params.transport?[e.params.transport]:["UDP","TCP","TLS"];s(e.host,(function(r,n){n=(n||[]).map((function(t){return o.map((function(r){return{protocol:r,address:t,port:e.port||j(r)}}))})).reduce((function(e,t){return e.concat(t)}),[]),t(n)}))}else{var a=(o=e.params.transport?[e.params.transport]:["tcp","udp","tls"]).length,i=[];o.forEach((function(r){D("_sip._"+r+"."+e.host,(function(n,c){--a,Array.isArray(c)?(a+=c.length,c.forEach((function(e){s(e.name,(function(n,s){i=i.concat((s||[]).map((function(t){return{protocol:r,address:t,port:e.port}}))),0==--a&&t(i)}))}))):0===a&&(i.length?t(i):s(e.host,(function(r,n){n=(n||[]).map((function(t){return o.map((function(r){return{protocol:r,address:t,port:e.port||j(r)}}))})).reduce((function(e,t){return e.concat(t)}),[]),t(n)})))}))}))}}function V(){return["z9hG4bK",Math.round(1e6*Math.random())].join("")}function z(){var e;return{enter:function(t){e&&e.leave&&e.leave(),e=t,Array.prototype.shift.apply(arguments),e.enter&&e.enter.apply(this,arguments)},signal:function(t){e&&e[t]&&e[Array.prototype.shift.apply(arguments)].apply(e,arguments)}}}function G(e,t){var r,n,s,o,a,i=z(),c={message:function(){r&&e(r)},send:function(t){r=t,t.status>=300?i.enter(u):t.status>=200&&i.enter(d),e(r)}},u={enter:function(){n=setTimeout((function t(s){n=setTimeout(t,2*s,2*s),e(r)}),500,500),s=setTimeout(i.enter.bind(i,l),32e3)},leave:function(){clearTimeout(n),clearTimeout(s)},message:function(t){"ACK"===t.method?i.enter(p):e(r)}},p={enter:function(){o=setTimeout(i.enter.bind(i,l),5e3)},leave:function(){clearTimeout(o)}},d={enter:function(){a=setTimeout(i.enter.bind(i,l),32e3)},leave:function(){clearTimeout(a)},send:function(t){e(r=t)}},l={enter:t};return i.enter(c),{send:i.signal.bind(i,"send"),message:i.signal.bind(i,"message"),shutdown:function(){i.enter(l)}}}function $(e,t){var r,n,s=z(),o={message:function(){r&&e(r)},send:function(t){r=t,e(t),t.status>=200&&s.enter(a)}},a={message:function(){e(r)},enter:function(){n=setTimeout((function(){s.enter(i)}),32e3)},leave:function(){clearTimeout(n)}},i={enter:t};return s.enter(o),{send:s.signal.bind(s,"send"),message:s.signal.bind(s,"message"),shutdown:function(){s.enter(i)}}}function Y(e,t,r,n,s){var o,a,i,c,u,p=z(),d={enter:function(){t(e),t.reliable||(o=setTimeout((function r(n){t(e),o=setTimeout(r,2*n,2*n)}),500,500)),a=setTimeout((function(){r(A(e,408)),p.enter(g)}),32e3)},leave:function(){clearTimeout(o),clearTimeout(a)},message:function(e){r(e),e.status<200?p.enter(l):e.status<300?p.enter(m):p.enter(f,e)}},l={enter:function(){0!==s.ringTimeLimit&&(i=setTimeout((function(){r(A(e,408)),p.enter(g)}),s.ringTimeLimit||6e5))},leave:function(){clearTimeout(i)},message:function(e){r(e),e.status>=300?p.enter(f,e):e.status>=200&&p.enter(m)}},h={method:"ACK",uri:e.uri,headers:{from:e.headers.from,cseq:{method:"ACK",seq:e.headers.cseq.seq},"call-id":e.headers["call-id"],via:[e.headers.via[0]],"max-forwards":s&&s["max-forwards"]||70}},f={enter:function(e){h.headers.to=e.headers.to,t(h),c=setTimeout(p.enter.bind(p,g),32e3)},leave:function(){clearTimeout(c)},message:function(e,r){r&&t(h)}},m={enter:function(){u=setTimeout((function(){p.enter(g)}),32e3)},leave:function(){clearTimeout(u)},message:function(e){e.status>=200&&e.status<=299&&r(e)}},g={enter:n};return process.nextTick((function(){p.enter(d)})),{message:p.signal.bind(p,"message"),shutdown:function(){p.enter(g)}}}function W(e,t,r,n){o.ok("INVITE"!==e.method);var s,a,i,c,u=z(),p={enter:function(){t(e),t.reliable||(s=setTimeout((function(){u.signal("timerE",500)}),500)),a=setTimeout((function(){u.signal("timerF")}),32e3)},leave:function(){clearTimeout(s),clearTimeout(a)},message:function(e,t){e.status>=200?u.enter(l):u.enter(d),r(e)},timerE:function(r){t(e),s=setTimeout((function(){u.signal("timerE",2*r)}),2*r)},timerF:function(){r(A(e,408)),u.enter(h)}},d={enter:function(){0!==options.ringTimeLimit&&(i=setTimeout((function(){r(A(e,408)),u.enter(h)}),options.ringTimeLimit||6e5))},leave:function(){clearTimeout(i)},message:function(e,t){e.status>=200&&u.enter(l),r(e)}},l={enter:function(){c=setTimeout((function(){u.enter(h)}),5e3)},leave:function(){clearTimeout(c)}},h={enter:n};return process.nextTick((function(){u.enter(p)})),{message:u.signal.bind(u,"message"),shutdown:function(){u.enter(h)}}}function H(e){return"ACK"===e.method?["INVITE",e.headers["call-id"],e.headers.via[0].params.branch].join():[e.headers.cseq.method,e.headers["call-id"],e.headers.via[0].params.branch].join()}function J(e,t){var r=Object.create(null),n=Object.create(null);return{createServerTransaction:function(e,t){var n=H(e);return r[n]=("INVITE"===e.method?G:$)(t.send.bind(t),(function(){delete r[n],t.release()}))},createClientTransaction:function(t,r,s){"CANCEL"!==r.method&&(r.headers.via[0].params.branch=V()),"object"!=typeof r.headers.cseq&&(r.headers.cseq=g({s:r.headers.cseq,i:0}));var o=t.send.bind(t);o.reliable="UDP"!==t.protocol.toUpperCase();var a=H(r);return n[a]=("INVITE"===r.method?Y:W)(r,o,s,(function(){delete n[a],t.release()}),e)},getServer:function(e){return r[H(e)]},getClient:function(e){return n[H(e)]},destroy:function(){Object.keys(n).forEach((function(e){n[e].shutdown()})),Object.keys(r).forEach((function(e){r[e].shutdown()}))}}}t.resolve=K,t.generateBranch=V,t.makeTransactionLayer=J,t.create=function(e,t){var r=e.logger&&e.logger.error||function(){},n=q(e,(function(e,o){try{if(a=e.method?s.getServer(e):s.getClient(e))a.message&&a.message(e,o);else if(e.method&&"ACK"!==e.method){var a=s.createServerTransaction(e,n.get(o));try{t(e,o)}catch(t){throw a.send(A(e,"500","Internal Server Error")),t}}else"ACK"===e.method&&t(e,o)}catch(e){r(e)}})),s=J(e,n.open.bind(n)),o=e.publicAddress||e.address||e.hostname||c.hostname(),a=e.port||5060,i=u.randomBytes(20);function p(e){var t=[e.protocol,e.address,e.port,e.local.address,e.local.port].join(),r=u.createHmac("sha1",i);return r.update(t),function(e){switch(e.length%3){case 1:e+="  ";break;case 2:e+=" "}return new Buffer.from(e).toString("base64").replace(/\//g,"_").replace(/\+/g,"-")}([r.digest("base64"),t].join())}function d(e){var t=new Buffer.from(e,"base64").toString("ascii").split(",");if(6==t.length){var r={protocol:t[1],address:t[2],port:+t[3],local:{address:t[4],port:+t[5]}};return p(r)==e?r:void 0}}return{send:function(e,t){if(void 0===e.method){var i=s.getServer(e);i&&i.send&&i.send(e)}else{var c=P(e.uri);if("string"==typeof e.headers.route)try{e.headers.route=b.route({s:e.headers.route,i:0})}catch(t){e.headers.route=void 0}e.headers.route&&e.headers.route.length>0&&((c=P(e.headers.route[0].uri)).host===o&&c.port===a?e.headers.route.shift():void 0===c.params.lr&&(e.headers.route.shift(),e.headers.route.push({uri:e.uri}),e.uri=c)),function(e){if(c.host===o&&c.port===a){var t=d(c.user);e(t?[t]:[])}else K(c,e)}((function(o){if("ACK"===e.method){if(Array.isArray(e.headers.via)||(e.headers.via=[]),0===e.headers.via.length&&e.headers.via.unshift({params:{branch:V()}}),0===o.length)return void r(new Error("ACK: couldn't resolve "+E(e.uri)));var a=n.open(o[0],r);try{a.send(e)}catch(e){r(e)}finally{a.release()}}else!function(e,t,r,n,s){var o,a;function i(){if(o=c,r.length>0)try{var i=r.shift(),u=e(t(i,(function(e){e&&console.log("err: ",e),u.message(A(n,503))})),n,(function(){o.apply(null,arguments)}))}catch(e){o(i.local?A(n,430):A(n,503))}else(o=s)(A(n,a||404))}function c(e){if(a=e.status,503===e.status)return i();e.status>100&&(o=s),s(e)}"CANCEL"!==n.method&&(n.headers.via||(n.headers.via=[]),n.headers.via.unshift({params:{}})),i()}(s.createClientTransaction.bind(s),n.open.bind(n),o,e,t||function(){})}))}},encodeFlowUri:function(e){return{schema:"TLS"===e.protocol?"sips":"sip",user:p(e),host:o,params:{}}},decodeFlowUri:function(e){return(e=P(e)).host===o?d(e.user):void 0},isFlowUri:function(e){return!decodeFlowUri(e)},hostname:function(){return o},destroy:function(){s.destroy(),n.destroy()}}},t.start=function(e,r){var n=t.create(e,r);t.send=n.send,t.stop=n.destroy,t.encodeFlowUri=n.encodeFlowUri,t.decodeFlowUri=n.decodeFlowUri,t.isFlowUri=n.isFlowUri,t.hostname=n.hostname}},963:e=>{"use strict";const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){const r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((e=>0===e.indexOf(r)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":r.relatedAddress=t[e+1];break;case"rport":r.relatedPort=parseInt(t[e+1],10);break;case"tcptype":r.tcpType=t[e+1];break;case"ufrag":r.ufrag=t[e+1],r.usernameFragment=t[e+1];break;default:void 0===r[t[e]]&&(r[t[e]]=t[e+1])}return r},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const r=e.component;"rtp"===r?t.push(1):"rtcp"===r?t.push(2):t.push(r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let r;const n=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<n.length;e++)r=n[e].trim().split("="),t[r[0].trim()]=r[1];return t},t.writeFmtp=function(e){let t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),r={ssrc:parseInt(e.substring(7,t),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substring(t+1,n),r.value=e.substring(n+1)):r.attribute=e.substring(t+1),r},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){const n=t.matchPrefix(e+r,"a=ice-ufrag:")[0],s=t.matchPrefix(e+r,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");r.profile=n[2];for(let s=3;s<n.length;s++){const o=n[s],a=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){const n=t.parseRtpMap(a),s=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(n.parameters=s.length?t.parseFmtp(s[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),r.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(n.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{r.headerExtensions.push(t.parseExtmap(e))}));const s=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return r.codecs.forEach((e=>{s.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),r},t.writeRtpDescription=function(e,r){let n="";n+="m="+e+" ",n+=r.codecs.length>0?"9":"0",n+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=r.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let s=0;return r.codecs.forEach((e=>{e.maxptime>s&&(s=e.maxptime)})),s>0&&(n+="a=maxptime:"+s+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const r=[],n=t.parseRtpParameters(e),s=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),i=a.length>0&&a[0].ssrc;let c;const u=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));u.length>0&&u[0].length>1&&u[0][0]===i&&(c=u[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:i,codecPayloadType:parseInt(e.parameters.apt,10)};i&&c&&(t.rtx={ssrc:c}),r.push(t),s&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:i,mechanism:o?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&i&&r.push({ssrc:i});let p=t.matchPrefix(e,"b=");return p.length&&(p=0===p[0].indexOf("b=TIAS:")?parseInt(p[0].substring(7),10):0===p[0].indexOf("b=AS:")?1e3*parseInt(p[0].substring(5),10)*.95-16e3:void 0,r.forEach((e=>{e.maxBitrate=p}))),r},t.parseRtcpParameters=function(e){const r={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);const s=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=s.length>0,r.compound=0===s.length;const o=t.matchPrefix(e,"a=rtcp-mux");return r.mux=o.length>0,r},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let r;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return r=n[0].substring(7).split(" "),{stream:r[0],track:r[1]};const s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return s.length>0?(r=s[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(e){const r=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let s;n.length>0&&(s=parseInt(n[0].substring(19),10)),isNaN(s)&&(s=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:r.fmt,maxMessageSize:s};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:s}}},t.writeSctpDescription=function(e,t){let r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,r,n){let s;const o=void 0!==r?r:2;return s=e||t.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+s+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,r){const n=t.splitLines(e);for(let e=0;e<n.length;e++)switch(n[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[e].substring(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const r=t.splitLines(e)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){const r=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const r=t.splitLines(e);for(let e=0;e<r.length;e++)if(r[e].length<2||"="!==r[e].charAt(1))return!1;return!0},e.exports=t},833:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return s(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SipManager=t.SipRequestHandler=t.TimeoutError=void 0,t.timeoutPromise=d,t.generateUuid=l,t.randomInteger=h,t.randomString=f,t.decodeSrtpOptions=m,t.getRtpDescription=v,t.parseRtpDescription=y;const i=o(r(494)),c=a(r(963)),u=a(r(982));class p extends Error{constructor(e){super("Operation Timed Out"),this.promise=e}}function d(e,t){return new Promise(((r,n)=>{const s=setTimeout((()=>n(new p(t))),e);t.then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),n(e)}))}))}function l(){return u.default.randomUUID()}function h(){return Math.floor(99999999*Math.random())+1e5}function f(e){return l().replace(/-/g,"").substring(0,e).toLowerCase()}function m(e){const t=Buffer.from(e,"base64");return{srtpKey:t.subarray(0,16),srtpSalt:t.subarray(16,30)}}function g(){return Math.floor(1e6*Math.random()).toString()}function v(e,t,r){try{const e=t.find((e=>e.startsWith("m="+r)));if(void 0===e)return{port:0,rtcpPort:0,srtpKey:void 0,srtpSalt:void 0};const{port:n}=c.default.parseMLine(e),s=c.default.splitLines(e),o=s.find((e=>e.startsWith("a=rtcp:"))),a=s.find((e=>e.startsWith("a=crypto"))),i=s.find((e=>e.startsWith("a=rtcp-mux"))),u=s.find((e=>e.startsWith("a=ssrc"))),p=s.find((e=>e.startsWith("a=ice-ufrag"))),d=s.find((e=>e.startsWith("a=ice-pwd"))),l=a?.match(/inline:(\S*)/)[1]||void 0;let h;return h=i?n:o&&Number(o.match(/rtcp:(\S*)/)?.[1])||n+1,{port:n,rtcpPort:h,ssrc:u&&Number(u.match(/ssrc:(\S*)/)?.[1])||void 0,iceUFrag:p&&p.match(/ice-ufrag:(\S*)/)?.[1]||void 0,icePwd:d&&d.match(/ice-pwd:(\S*)/)?.[1]||void 0,...l?m(l):{srtpKey:void 0,srtpSalt:void 0}}}catch(r){throw e.error("Failed to parse SDP from remote end"),e.error(t.join("\r\n")),r}}function y(e,t){const r=c.default.splitSections(t.content),n=c.default.splitLines(r[0]).find((e=>e.startsWith("c=")));return{sdp:t.content,address:n.match(/c=IN IP4 (\S*)/)[1],audio:v(e,r,"audio"),video:v(e,r,"video")}}t.TimeoutError=p,t.SipRequestHandler=class{};class b{constructor(){this.subscriptions=[]}subscribe(e){this.subscriptions.push(e)}next(e){for(;this.subscriptions.length>0;)this.subscriptions.pop()(e)}}t.SipManager=class{constructor(e,t){this.sipOptions=t,this.seq=20,this.fromParams={tag:g()},this.toParams={},this.callId=g(),this.onEndedByRemote=new b,this.destroyed=!1,this.audioUfrag=f(16),this.videoUfrag=f(16),this.console=e;const r=this.sipOptions.localIp,n=this.sipOptions.localPort;this.sipStack={makeResponse:i.default.makeResponse,...i.default.create({host:r,hostname:r,port:n,udp:!this.sipOptions.useTcp,tcp:this.sipOptions.useTcp,tls:!1,ws:!1,logger:{error:function(t){e.error(t)},recv:function(r,n){("200"==r.status||"INVITE"===r.method)&&r.headers&&r.headers.cseq&&"INVITE"===r.headers.cseq.method&&r.headers.contact&&r.headers.contact[0]&&(this.registrarContact=r.headers.contact[0].uri),t.debugSip&&e.log(`<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n${(0,i.stringify)(r)}\r\n<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<`)},appendGruu:function(e,r){t.gruuInstanceId&&e&&e[0]&&(e[0].params||(e[0].params={}),e[0].params["+sip.instance"]='"<urn:uuid:'+t.gruuInstanceId+'>"',r&&(e[0].uri=e[0].uri+";gr=urn:uuid:"+t.gruuInstanceId))},send:function(r,n){if(t.domain&&t.domain.length>0){let s=(t.to.split("@")[0]+"@"+t.domain).trim(),o=(t.from.split("@")[0]+"@"+t.domain).trim();"REGISTER"==r.method?(r.uri="sip:"+t.domain,r.headers.to.uri=o,this.appendGruu(r.headers.contact)):"INVITE"==r.method||"MESSAGE"==r.method?(r.uri=s,r.headers.to.uri=s,"MESSAGE"==r.method&&r.headers.to&&(r.headers.to.params=null)):"ACK"==r.method||"BYE"==r.method?(r.headers.to.uri=s,this.registrarContact&&(r.uri=this.registrarContact)):null==r.method&&r.status&&r.headers.cseq?"200"==r.status&&this.appendGruu(r.headers.contact,!0):e.error("Error: Method construct for uri not implemented: "+r.method),r.method&&(r.headers.from.uri=o,r.headers.contact&&r.headers.contact[0].uri.split("@")[0].lastIndexOf("-")<0&&"udp"!=n.protocol&&r.headers.contact[0].uri.indexOf("transport=")<0&&(r.headers.contact[0].uri=r.headers.contact[0].uri+";transport="+n.protocol))}t.debugSip&&e.log(`>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n${(0,i.stringify)(r)}\r\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>`)}}},(e=>{if("BYE"===e.method)this.console.info("received BYE from remote end"),this.sipStack.send(this.sipStack.makeResponse(e,200,"Ok")),this.destroyed||this.onEndedByRemote.next(null);else if("MESSAGE"===e.method&&t.sipRequestHandler)t.sipRequestHandler.handle(e),this.sipStack.send(this.sipStack.makeResponse(e,200,"Ok"));else if("INVITE"===e.method&&t.sipRequestHandler){let r=this.sipStack.makeResponse(e,180,"Ringing");this.toParams.tag=g(),r.headers.to.params.tag=this.toParams.tag,r.headers["record-route"]=e.headers["record-route"],r.headers.supported="replaces, outbound, gruu",this.sipStack.send(r),t.sipRequestHandler.handle(e)}else"CANCEL"===e.method||"ACK"===e.method?t.sipRequestHandler.handle(e):t.debugSip&&this.console.warn("unimplemented method received from remote: "+e.method)}))}}request({method:e,headers:t,content:r,seq:n}){return this.destroyed?Promise.reject(new Error("SIP request made after call was destroyed")):new Promise(((s,o)=>{n=n||this.seq++,this.sipStack.send({method:e,uri:this.sipOptions.to,headers:{to:{uri:this.sipOptions.to,params:"REGISTER"==e||"INVITE"==e?null:this.toParams},from:{uri:this.sipOptions.from,params:this.fromParams},"max-forwards":70,"call-id":this.callId,cseq:{seq:n,method:e},...t},content:r||""},(t=>{t.headers.to.params&&t.headers.to.params.tag&&(this.toParams.tag=t.headers.to.params.tag),t.headers.from.params&&t.headers.from.params.tag&&(this.fromParams.tag=t.headers.from.params.tag),t.status>=300?(408===t.status&&"BYE"===e||this.console.error(`sip ${e} request failed with status `+t.status),o(new Error(`sip ${e} request failed with status `+t.status))):t.status<200||("INVITE"===e&&this.acknowledge(n).catch((e=>{this.console.error("Failed to send SDP ACK"),this.console.error(e)})),s(t))}))}))}async acknowledge(e){this.request({method:"ACK",seq:e}).catch((()=>{}))}setSipOptions(e){this.sipOptions=e}sendDtmf(e){return this.request({method:"INFO",headers:{"Content-Type":"application/dtmf-relay"},content:`Signal=${e}\r\nDuration=250`})}async invite(e,t,r,n){let s=h(),o=t?t(e?.audio,s):[],a=r?r(e?.video,s):[];const{from:i,localIp:c}=this.sipOptions;if(n){let e=this.sipStack.makeResponse(n,200,"Ok",{headers:{supported:"replaces, outbound, gruu",allow:"INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO, UPDATE","content-type":"application/sdp"},content:["v=0",`o=${i.split(":")[1].split("@")[0]} 3747 461 IN IP4 ${c}`,"s=ScryptedSipPlugin",`c=IN IP4 ${this.sipOptions.localIp}`,"t=0 0",...o,...a].filter((e=>e)).join("\r\n")+"\r\n"});n.headers["record-route"]&&(e.headers["record-route"]=n.headers["record-route"]);let t=(i.split("@")[0]+"@"+this.sipOptions.domain).trim();return e.headers.contact=[{uri:t}],this.fromParams.tag=n.headers.to.params.tag,this.toParams.tag=n.headers.from.params.tag,this.callId=n.headers["call-id"],await this.sipStack.send(e),y(this.console,n)}{(this.sipOptions.to.toLocaleLowerCase().indexOf("c300x")>=0||this.sipOptions.to.toLocaleLowerCase().indexOf("c100x")>=0)&&o.unshift("a=DEVADDR:"+this.sipOptions.devaddr);let e=await this.request({method:"INVITE",headers:{supported:"replaces, outbound, gruu",allow:"INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO, UPDATE","content-type":"application/sdp",contact:[{uri:i}]},content:["v=0",`o=${i.split(":")[1].split("@")[0]} 3747 461 IN IP4 ${c}`,"s=ScryptedSipPlugin",`c=IN IP4 ${this.sipOptions.localIp}`,"t=0 0",...o,...a].filter((e=>e)).join("\r\n")+"\r\n"});return y(this.console,e)}}async register(){const{from:e}=this.sipOptions;await d(3e3,this.request({method:"REGISTER",headers:{supported:"replaces, outbound, gruu",allow:"INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO, UPDATE",contact:[{uri:e}],expires:this.sipOptions.expire}}).catch((()=>{})))}async message(e){const{from:t}=this.sipOptions;return await this.request({method:"MESSAGE",headers:{allow:"INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO, UPDATE","content-type":"text/plain",contact:[{uri:t,params:{expires:this.sipOptions.expire}}]},content:e})}async sendBye(){return this.console.log("Sending BYE..."),await d(3e3,this.request({method:"BYE"}).catch((()=>{})))}destroy(){this.console.debug("detroying sip-manager"),this.destroyed=!0,this.sipStack.destroy(),this.console.debug("detroying sip-manager: done")}}},613:e=>{"use strict";e.exports=require("assert")},982:e=>{"use strict";e.exports=require("crypto")},194:e=>{"use strict";e.exports=require("dgram")},250:e=>{"use strict";e.exports=require("dns")},278:e=>{"use strict";e.exports=require("net")},857:e=>{"use strict";e.exports=require("os")},756:e=>{"use strict";e.exports=require("tls")},23:e=>{"use strict";e.exports=require("util")}},t={},r=function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,r),o.exports}(833);for(var n in r)this[n]=r[n];r.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();
//# sourceMappingURL=sip-bundle.js.map